#!/usr/bin/env python3
"""
TGS to WebP Converter - Render.com Compatible Version
"""

import os
import sys
import gzip
import zlib
import subprocess
import tempfile
import json
import uuid
from shutil import which
from flask import Flask, render_template_string, request, send_file, redirect, url_for, flash
from werkzeug.utils import secure_filename

app = Flask(__name__)
app.secret_key = os.environ.get('SECRET_KEY', 'tgs-webp-converter-secret-key-2024')

# Configuration for Render.com
UPLOAD_FOLDER = '/tmp/uploads'
OUTPUT_FOLDER = '/tmp/outputs'
ALLOWED_EXTENSIONS = {'tgs'}
MAX_FILE_SIZE = 16 * 1024 * 1024  # 16MB

app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
app.config['OUTPUT_FOLDER'] = OUTPUT_FOLDER
app.config['MAX_CONTENT_LENGTH'] = MAX_FILE_SIZE

# Ensure directories exist
os.makedirs(UPLOAD_FOLDER, exist_ok=True)
os.makedirs(OUTPUT_FOLDER, exist_ok=True)

def allowed_file(filename):
    return '.' in filename and \
           filename.rsplit('.', 1)[1].lower() in ALLOWED_EXTENSIONS

def convert_tgs_to_webp(input_path, output_path, quality=80, width=512, height=512):
    """
    Convert TGS file to WebP using available methods
    """
    print(f"Converting {input_path} to {output_path}")

    # Method 1: Using lottie Python package (primary method)
    try:
        import lottie
        print("Using lottie Python package...")

        # Load animation
        animation = lottie.parsers.tgs.parse_tgs(input_path)

        # Export to WebP
        lottie.exporters.export_webp(animation, output_path,
                                    quality=quality,
                                    width=width,
                                    height=height)
        print("Successfully converted to WebP using lottie package")
        return True
    except ImportError:
        print("lottie Python package not available")
    except Exception as e:
        print("Error using lottie package:", e)

    # Method 2: Using lottie-converter CLI (fallback)
    lottie_cli = find_executable("lottie_convert.py") or find_executable("lottie-convert") or find_executable("lottie_convert")

    if lottie_cli:
        print("Found lottie CLI:", lottie_cli)
        try:
            # Convert to WebP using lottie-converter
            cmd = [lottie_cli, input_path, output_path]
            print("Running:", " ".join(cmd))
            result = subprocess.run(cmd, capture_output=True, text=True, timeout=30)
            if result.returncode == 0:
                print("Successfully converted to WebP using lottie CLI")
                return True
            else:
                print("lottie CLI error:", result.stderr)
        except Exception as e:
            print("lottie CLI failed:", e)

    # Method 3: Convert via GIF first (last resort)
    try:
        print("Trying fallback method: TGS -> GIF -> WebP")
        with tempfile.NamedTemporaryFile(suffix='.gif', delete=False) as temp_gif:
            temp_gif_path = temp_gif.name

        # First convert to GIF
        import lottie
        animation = lottie.parsers.tgs.parse_tgs(input_path)
        lottie.exporters.gif.export_gif(animation, temp_gif_path)

        # Then convert GIF to WebP
        from PIL import Image
        img = Image.open(temp_gif_path)
        img.save(output_path, 'WEBP', quality=quality, save_all=True, duration=img.info.get('duration', 100), loop=0)

        # Cleanup
        os.unlink(temp_gif_path)
        print("Successfully converted to WebP via GIF fallback")
        return True
    except Exception as e:
        print("Fallback method also failed:", e)

    return False

def find_executable(name):
    return which(name)

def check_dependencies():
    """Check if required dependencies are available"""
    dependencies = {
        'lottie': False,
        'PIL (Pillow)': False,
        'lottie-converter CLI': False
    }
    
    try:
        import lottie
        dependencies['lottie'] = True
    except ImportError:
        pass
        
    try:
        from PIL import Image
        dependencies['PIL (Pillow)'] = True
    except ImportError:
        pass
        
    if find_executable("lottie_convert.py") or find_executable("lottie-convert") or find_executable("lottie_convert"):
        dependencies['lottie-converter CLI'] = True
        
    return dependencies

# HTML Template
HTML_TEMPLATE = '''
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TGS to WebP Converter</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .container { background: white; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); width: 100%; max-width: 700px; overflow: hidden; }
        .header { background: #4a5568; color: white; padding: 25px; text-align: center; }
        .header h1 { font-size: 28px; margin-bottom: 10px; }
        .content { padding: 30px; }
        .upload-area { border: 2px dashed #cbd5e0; border-radius: 8px; padding: 40px 20px; text-align: center; margin-bottom: 25px; transition: all 0.3s; cursor: pointer; }
        .upload-area:hover { border-color: #667eea; background-color: #f7fafc; }
        .browse-btn { background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 16px; }
        .file-input { display: none; }
        .selected-file { margin-top: 15px; padding: 10px; background: #edf2f7; border-radius: 6px; }
        .settings { margin-bottom: 25px; }
        .form-group { margin-bottom: 15px; }
        .form-control { width: 100%; padding: 10px 15px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 16px; }
        .convert-btn { background: #48bb78; color: white; border: none; padding: 15px; border-radius: 6px; cursor: pointer; font-size: 18px; width: 100%; }
        .alert { padding: 15px; border-radius: 6px; margin-bottom: 20px; }
        .alert-error { background: #fed7d7; color: #c53030; }
        .alert-success { background: #c6f6d5; color: #276749; }
        .result-container { text-align: center; padding: 30px; }
        .success-icon { font-size: 64px; color: #48bb78; margin-bottom: 20px; }
        .download-btn { background: #667eea; color: white; padding: 15px 30px; border-radius: 6px; text-decoration: none; display: inline-block; margin: 20px 0; }
        .dependencies { background: #f7fafc; padding: 15px; border-radius: 6px; margin: 20px 0; }
        .loading { display: none; text-align: center; margin: 20px 0; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ TGS to WebP Converter</h1>
            <p>Render.com Hosted - Real TGS to WebP Conversion</p>
        </div>
        
        <div class="content">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">{{ message }}</div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            
            <div class="dependencies">
                <h3>üìã System Dependencies Check</h3>
                {% for name, status in dependencies.items() %}
                <div style="display: flex; justify-content: space-between; margin: 8px 0;">
                    <span>{{ name }}</span>
                    <span style="color: {% if status %}#48bb78{% else %}#e53e3e{% endif %};">
                        {% if status %}‚úÖ Available{% else %}‚ùå Missing{% endif %}
                    </span>
                </div>
                {% endfor %}
            </div>
            
            {% if not conversion_success %}
            <form method="post" action="/convert" enctype="multipart/form-data" id="upload-form">
                <div class="upload-area" id="upload-area">
                    <div style="font-size: 48px; color: #a0aec0; margin-bottom: 15px;">üìÅ</div>
                    <p style="color: #4a5568; margin-bottom: 15px;">Drag & drop your TGS file here or click to browse</p>
                    <button type="button" class="browse-btn" onclick="document.getElementById('file').click()">Browse Files</button>
                    <input type="file" id="file" class="file-input" name="file" accept=".tgs" required>
                    <div class="selected-file" id="selected-file">No file selected</div>
                </div>
                
                <div class="settings">
                    <h3>‚öôÔ∏è Conversion Settings</h3>
                    <div class="form-group">
                        <label for="quality">Quality (1-100)</label>
                        <input type="number" id="quality" name="quality" class="form-control" min="1" max="100" value="80">
                    </div>
                    <div class="form-group">
                        <label for="width">Width (pixels)</label>
                        <input type="number" id="width" name="width" class="form-control" min="1" value="512">
                    </div>
                    <div class="form-group">
                        <label for="height">Height (pixels)</label>
                        <input type="number" id="height" name="height" class="form-control" min="1" value="512">
                    </div>
                </div>
                
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>Converting your file... Please wait</p>
                </div>
                
                <button type="submit" class="convert-btn" id="convert-btn">üîÑ Convert to WebP</button>
            </form>
            {% else %}
            <div class="result-container">
                <div class="success-icon">‚úÖ</div>
                <h2>Conversion Successful!</h2>
                <p>Your TGS file has been converted to WebP format.</p>
                <p><strong>Original:</strong> {{ original_filename }}</p>
                <p><strong>Converted:</strong> {{ webp_filename }}</p>
                
                <a href="/download/{{ file_id }}" class="download-btn">üì• Download WebP File</a>
                <br>
                <a href="/" style="color: #667eea; text-decoration: none; margin-top: 10px; display: inline-block;">üîÑ Convert Another File</a>
            </div>
            {% endif %}
        </div>
    </div>

    <script>
        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('file');
        const selectedFile = document.getElementById('selected-file');
        const loading = document.getElementById('loading');
        const convertBtn = document.getElementById('convert-btn');
        
        if (uploadArea && fileInput) {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, () => uploadArea.style.borderColor = '#667eea');
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, () => uploadArea.style.borderColor = '#cbd5e0');
            });
            
            uploadArea.addEventListener('drop', handleDrop, false);
            
            function handleDrop(e) {
                const files = e.dataTransfer.files;
                fileInput.files = files;
                handleFiles(files);
            }
            
            fileInput.addEventListener('change', function() { handleFiles(this.files); });
            
            function handleFiles(files) {
                if (files.length > 0) {
                    selectedFile.textContent = `Selected: ${files[0].name}`;
                }
            }
        }

        document.getElementById('upload-form')?.addEventListener('submit', function() {
            loading.style.display = 'block';
            convertBtn.disabled = true;
            convertBtn.textContent = 'Converting...';
        });
    </script>
</body>
</html>
'''

@app.route('/')
def index():
    dependencies = check_dependencies()
    return render_template_string(HTML_TEMPLATE, 
                                dependencies=dependencies,
                                conversion_success=False)

@app.route('/convert', methods=['POST'])
def convert_file():
    if 'file' not in request.files:
        flash('No file selected', 'error')
        return redirect('/')
    
    file = request.files['file']
    
    if file.filename == '':
        flash('No file selected', 'error')
        return redirect('/')
    
    if not allowed_file(file.filename):
        flash('Invalid file type. Please upload a .tgs file', 'error')
        return redirect('/')
    
    quality = int(request.form.get('quality', 80))
    width = int(request.form.get('width', 512))
    height = int(request.form.get('height', 512))
    
    file_id = str(uuid.uuid4())
    input_filename = secure_filename(file.filename)
    input_path = os.path.join(app.config['UPLOAD_FOLDER'], f"{file_id}_{input_filename}")
    output_filename = f"{os.path.splitext(input_filename)[0]}.webp"
    output_path = os.path.join(app.config['OUTPUT_FOLDER'], f"{file_id}_{output_filename}")
    
    file.save(input_path)
    
    try:
        success = convert_tgs_to_webp(input_path, output_path, quality, width, height)
        
        if success and os.path.exists(output_path):
            if os.path.exists(input_path):
                os.remove(input_path)
                
            dependencies = check_dependencies()
            return render_template_string(HTML_TEMPLATE,
                                        dependencies=dependencies,
                                        conversion_success=True,
                                        original_filename=input_filename,
                                        webp_filename=output_filename,
                                        file_id=file_id)
        else:
            flash('Conversion failed. Please check if TGS file is valid.', 'error')
            return redirect('/')
            
    except Exception as e:
        flash(f'An error occurred: {str(e)}', 'error')
        return redirect('/')

@app.route('/download/<file_id>')
def download_file(file_id):
    for filename in os.listdir(app.config['OUTPUT_FOLDER']):
        if filename.startswith(file_id):
            file_path = os.path.join(app.config['OUTPUT_FOLDER'], filename)
            if os.path.exists(file_path):
                response = send_file(file_path, as_attachment=True)
                
                @response.call_on_close
                def cleanup():
                    if os.path.exists(file_path):
                        os.remove(file_path)
                
                return response
    
    flash('File not found', 'error')
    return redirect('/')

if __name__ == '__main__':
    port = int(os.environ.get('PORT', 5000))
    app.run(host='0.0.0.0', port=port)
